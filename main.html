<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
  <script>
    window.addEventListener("load", init);

    function init() {
      var stage = new createjs.Stage("myCanvas");

      // 背景画像
      var imgSrc = "./poma.png";
      var backImg = new createjs.Bitmap(imgSrc);
      stage.addChild(backImg);
      // クリック時に呼び出される関数登録
      backImg.addEventListener("click", threadCalc);

      stage.update(); //画像表示


      // 円の設定
      var circles = new createjs.Container();
      circles.radius = 0;
      stage.addChild(circles);
      //var circles = []; //円をまとめる配列
      var colors = ['#D0A000', '#6DD0A5', '#E084C5'];

      // 円オブジェクトの作成
      function createCircle(x, y, scale, color) {
        // 円オブジェクト
        var shape = new createjs.Shape();

        shape.graphics.setStrokeStyle(1) // 4pxの線幅を設定
          .beginStroke(color) // 青色の線を描画するように設定
          .drawCircle(0, 0, scale); //半径100pxの円を描画

        shape.x = x;
        shape.y = y;

        return shape;
      }

      // websocket
      socket = new WebSocket("ws://localhost:8881/chat");
      socket.onopen = function() {};

      // 円情報を受信
      socket.onmessage = function(jsonMsg) {
        console.log(jsonMsg.data);
        // 新しい円を追加
        var msg = JSON.parse(jsonMsg.data);

        var circle = createCircle(msg["x"], msg["y"], msg["scale"], msg["color"]);
        circles.addChild(circle);
      };

      // canvasがクリックされたら呼び出し
      function threadCalc(event) {
        console.log(imgSrc);
        // 円情報をjson形式でまとめる
        var msg = {};
        msg.x = stage.mouseX;
        msg.y = stage.mouseY;
        msg.scale = 4;
        msg.color = colors[~~(Math.random() * 3)];
        jsonMsg = window.JSON.stringify(msg);

        // websocketサーバに円情報送信
        socket.send(jsonMsg);
      }


      createjs.Ticker.addEventListener("tick", handleTick);

      function handleTick() {

        circles.radius += 1;
        stage.update();
      }

    }
  </script>
</head>

<body>
  <canvas id="myCanvas" width="640" height="500"></canvas>
</body>

</html>
